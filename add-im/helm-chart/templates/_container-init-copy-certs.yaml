{{/*
Init container for copying certificates
*/}}
{{- define "x-road-ss.container.init.copyCerts" -}}
- name: copy-certificates
  image: "{{ index .Values "security-server" "initContainer" "repository" }}:{{ index .Values "security-server" "initContainer" "imageTag" }}"
  imagePullPolicy: Always
  command:
    - sh
    - -c
  args:
    - |
      # set -euo pipefail
      
      echo "=== X-Road Security Server Init Container ==="

      echo "--- Installing rsync..."
      apt-get update && apt-get install -y rsync

      echo "--- Listing shared volume before copy..."
      find /shared-volume -type f -exec sha256sum {} \;

      echo "--- Handling certificates..."
      mkdir -p /shared-volume/ssl
      cd /shared-volume/ssl
      ls -lath

      # Check if certificates already exist from previous installation (persisted)
      if [ -f certificate.crt ] && [ -f certificate.key ]; then
        echo "--- Existing certificates found in persistent storage, preserving them..."
        # Remove old symlinks if they exist
        rm -vf internal.* proxy-ui-api.* 2>/dev/null || true
        # Recreate symlinks for existing certificates
        if [ -f certificate-ss-internal.p12 ]; then
          ln -vs certificate-ss-internal.p12 internal.p12
        fi
        if [ -f certificate-ss-ui.p12 ]; then
          ln -vs certificate-ss-ui.p12 proxy-ui-api.p12
        fi
        if [ -f certificate.crt ]; then
          ln -vs certificate.crt proxy-ui-api.crt
          ln -vs certificate.crt internal.crt
        fi
        if [ -f certificate.key ]; then
          ln -vs certificate.key proxy-ui-api.key
          ln -vs certificate.key internal.key
        fi
        echo "--- Certificates preserved from previous installation"
      # If no existing certificates, check if they're provided via secret (first installation)
      elif [ -d /certs ] && [ "$(ls -A /certs 2>/dev/null)" ]; then
        echo "--- No existing certificates found, copying from /certs (first installation)..."
        rm -vf internal.* proxy-ui-api.* 2>/dev/null || true
        cp -v /certs/certificate-ss-* ./ 2>/dev/null || true
        if [ -f /certs/certificate-ss.crt ]; then
          cp -v /certs/certificate-ss.crt ./certificate.crt
        fi
        if [ -f /certs/certificate-ss.key ]; then
          cp -v /certs/certificate-ss.key ./certificate.key
        fi
        if [ -f certificate-ss-internal.p12 ]; then
          ln -vs certificate-ss-internal.p12 internal.p12
        fi
        if [ -f certificate-ss-ui.p12 ]; then
          ln -vs certificate-ss-ui.p12 proxy-ui-api.p12
        fi
        if [ -f certificate.crt ]; then
          ln -vs certificate.crt proxy-ui-api.crt
          ln -vs certificate.crt internal.crt
        fi
        if [ -f certificate.key ]; then
          ln -vs certificate.key proxy-ui-api.key
          ln -vs certificate.key internal.key
        fi
        echo "--- Certificates copied from secret (first installation)"
      else
        echo "--- No certificates found (neither persisted nor in secret)"
        echo "--- Certificates will be created via SS UI during configuration"
        echo "--- They will persist in /shared-volume/ssl for future deployments"
      fi
      
      ls -lath

      echo "--- Setting proper permissions..."
      chown -R 999:999 /shared-volume/ssl
      chmod 660 /shared-volume/ssl/*
      
      echo "--- Verifying copied files..."
      ls -la /shared-volume/ssl/

      echo "--- Creating local.properties with truststore settings..."
      mkdir -p /shared-volume/services
      echo 'XROAD_PARAMS=-Djavax.net.ssl.trustStore=/shared-truststore/cacerts -Djavax.net.ssl.trustStorePassword=changeit -Djavax.net.ssl.trustStoreType=JKS' > /shared-volume/services/local.properties
      chmod 644 /shared-volume/services/local.properties
      echo "--- local.properties created with truststore settings"

      echo "--- Listing shared volume after copy..."
      find /shared-volume -type f -exec sha256sum {} \;

      echo "--- Init container completed successfully!"
      sleep 5
  volumeMounts:
    - mountPath: /shared-volume
      name: xroad-config
    {{- if .Files.Get "certs/certificate-ss.crt" }}
    - mountPath: /certs
      name: certs
    {{- end }}
      readOnly: true
{{- end }}

