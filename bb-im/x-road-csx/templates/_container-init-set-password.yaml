{{/*
Init container for setting CS admin password
*/}}
{{- define "x-road-csx.container.init.setPassword" -}}
- name: set-cs-admin-password
  image: "{{ index .Values "central-server" "repository" }}:{{ index .Values "central-server" "imageTag" }}"
  imagePullPolicy: Always
  command:
    - bash
    - -c
  args:
    - |
      set -euo pipefail

      echo "=== Changing password for xrd admin user ==="
      # Verify password variable is set
      if [ -z "${XROAD_ADMIN_PASSWORD:-}" ]; then
        echo "ERROR: XROAD_ADMIN_PASSWORD environment variable is not set"
        exit 1
      fi
      echo "Password length: ${#XROAD_ADMIN_PASSWORD}"
      # Use chpasswd which is more reliable for non-interactive password setting
      echo "xrd:${XROAD_ADMIN_PASSWORD}" | chpasswd
      if [ $? -ne 0 ]; then
        echo "ERROR: chpasswd failed to set password"
        exit 1
      fi
      echo "=== Password for user xrd has been changed ==="
      # Verify the password was set
      if grep -q "^xrd:" /etc/shadow; then
        PWD_HASH=$(grep "^xrd:" /etc/shadow | cut -d: -f2)
        if [ -z "$PWD_HASH" ] || [ "$PWD_HASH" = "*" ] || [ "$PWD_HASH" = "!" ]; then
          echo "ERROR: Password was not set correctly (hash is empty, *, or !)"
          exit 1
        else
          echo "OK: Password hash is set (starts with: ${PWD_HASH:0:3}...)"
        fi
      else
        echo "ERROR: User xrd not found in /etc/shadow"
        exit 1
      fi
  env:
    - name: XROAD_ADMIN_PASSWORD
      valueFrom:
        secretKeyRef:
          name: {{ include "x-road-csx.fullnameWithId" . }}
          key: password
{{- end }}

